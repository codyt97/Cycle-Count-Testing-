<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ConnectUs ‚Ä¢ Cycle Count ‚Äì Bin Scan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --cu-green:#8BC53F; --cu-green-600:#6eab2f; --cu-green-50:#f3fbeb;
      --ink:#0b0d12; --ink-2:#3b3f45; --ink-3:#6b7280; --border:#e6e9ee;
      --card:#ffffff; --bg:#ffffff; --warn:#dc2626;
      --shadow:0 1px 2px rgba(0,0,0,.05), 0 8px 24px rgba(0,0,0,.06);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter;color:var(--ink);background:var(--bg)}
    /* Header */
    .topbar{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.92);backdrop-filter:saturate(160%) blur(8px);border-bottom:1px solid var(--border)}
    .container{max-width:1120px;margin:0 auto;padding:14px 22px}
    .brand{display:flex;align-items:center;gap:14px}
    .brand img{height:28px;width:auto;display:block}
    .title{font-weight:800;font-size:18px}
    .subtitle{color:var(--ink-3);font-size:13px;margin-top:2px}
    .kpis{display:flex;gap:8px;align-items:center}
    .chip{background:#f6f9f3;border:1px solid var(--border);border-radius:999px;padding:6px 12px;display:flex;gap:8px;align-items:center}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--cu-green)}
    .chip .lbl{font-size:11px;color:var(--ink-3)}
    .chip .val{font-weight:700;color:var(--ink)}
    main .container{display:grid;gap:16px;padding-top:18px}
    /* Cards */
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .card .head{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .card .h1{font-weight:700}
    .card .h2{color:var(--ink-3);font-size:12px;margin-top:2px}
    .card .body{padding:14px 16px}
    /* Inputs & Buttons */
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .field{flex:1;display:flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:#fff}
    .field input{flex:1;border:0;outline:none;font:inherit;color:inherit;background:transparent}
    .btn{appearance:none;border:1px solid transparent;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;transition:.15s all ease}
    .btn.primary{background:var(--cu-green);color:#0a0a0a;border-color:var(--cu-green)}
    .btn.primary:hover{background:var(--cu-green-600);border-color:var(--cu-green-600)}
    .btn.ghost{background:#fff;border-color:var(--border);color:var(--ink-2)}
    .btn.ghost:hover{border-color:var(--cu-green);color:var(--ink)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    /* Alerts */
    .alerts{display:grid;gap:8px}
    .alert{border-left:4px solid;padding:10px 12px;border-radius:10px;background:#f7fafc;border:1px solid var(--border)}
    .alert.ok{border-left-color:var(--cu-green);background:var(--cu-green-50)}
    .alert.warn{border-left-color:var(--warn);background:#fdecec}
    /* Sticky scan bar */
    .stickybar{position:sticky;top:64px;z-index:40;background:#fff;border-bottom:1px solid var(--border);padding:12px 16px;display:flex;align-items:center;gap:12px}
    /* Table */
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead tr{background:#f8fafc}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left}
    th{font-size:12px;color:var(--ink-3);text-transform:uppercase;letter-spacing:.04em}
    tr.ok{background:var(--cu-green-50)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    .qty{display:inline-grid;place-items:center;width:30px;height:30px;border-radius:50%;font-weight:800;background:#eef3ea;color:#1f3a1a}
    .qty.is1{background:var(--cu-green);color:#0a0a0a}
    .empty{text-align:center;color:var(--ink-3);padding:30px 16px}
    .footnote{color:var(--ink-3);font-size:12px}
    /* Menus & Panel */
    .menu{position:relative}
    .menu-list{position:absolute;right:0;top:calc(100% + 6px);min-width:220px;background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:6px;display:none;z-index:60}
    .menu.open .menu-list{display:block}
    .menu-item{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:8px 10px;border-radius:10px;cursor:pointer}
    .menu-item:hover{background:#f6f9f3}
    .muted{color:var(--ink-3);font-size:12px}
    .actions{display:flex;gap:8px;margin-left:auto}
    /* Audit panel (drawer) */
    .drawer{position:fixed;right:0;top:0;height:100vh;width:420px;max-width:90vw;background:#fff;border-left:1px solid var(--border);box-shadow:var(--shadow);transform:translateX(100%);transition:transform .2s ease;z-index:70;display:flex;flex-direction:column}
    .drawer.open{transform:translateX(0)}
    .drawer header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .drawer main{padding:14px 16px;overflow:auto}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid var(--border);color:var(--ink-3)}
    .row-sm{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .btn.sm{padding:6px 10px;border-radius:10px;font-weight:700}
    @media (max-width: 780px){ .kpis{display:none} .stickybar{flex-wrap:wrap} .actions{width:100%;justify-content:flex-start} }
  </style>
</head>
<body>
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="container" style="display:flex;justify-content:space-between;align-items:center;">
      <div class="brand">
        <img alt="ConnectUs" src="./downalod.png" width="301" height="83" />
        <div>
          <div class="title">Cycle Count ‚Äì Bin Scan</div>
          <div class="subtitle">Match scanned IMEIs to system snapshot ‚Ä¢ hard-fail wrong bins</div>
        </div>
      </div>
      <div class="kpis" id="kpis">
        <div class="chip"><span class="dot"></span><span class="lbl">Total</span><span class="val" id="kpi-total">0</span></div>
        <div class="chip"><span class="dot"></span><span class="lbl">Scanned</span><span class="val" id="kpi-scanned">0</span></div>
        <div class="chip"><span class="dot"></span><span class="lbl">Missing</span><span class="val" id="kpi-missing">0</span></div>
      </div>
    </div>
  </div>

  <main>
    <div class="container">
      <!-- SEARCH CARD -->
      <section class="card" aria-labelledby="searchTitle">
        <div class="head">
          <div>
            <div class="h1" id="searchTitle">Search Bin</div>
            <div class="h2">Enter a location (e.g., K-01-01) to load system IMEIs (SKU, Description, IMEI)</div>
          </div>
        </div>
        <div class="body">
          <form id="binForm" class="row" autocomplete="off">
            <div class="field" aria-live="polite">
              <span aria-hidden="true">üì¶</span>
              <input id="binInput" type="text" placeholder="Bin (e.g., K-01-01)" required />
            </div>
            <button class="btn primary" id="binSubmit" type="submit">Search Bin</button>
            <button class="btn ghost" id="resetBtn" type="button">Reset</button>
          </form>
        </div>
      </section>

      <!-- ALERTS -->
      <div class="alerts" id="alerts" style="display:none"></div>

      <!-- SCAN + TABLE CARD -->
      <section class="card" id="resultsCard" style="display:none">
        <div class="stickybar">
          <form id="scanForm" class="row" style="flex:1" autocomplete="off">
            <div class="field" style="flex:1">
              <span aria-hidden="true">üîé</span>
              <input id="scanInput" inputmode="numeric" placeholder="Scan / enter IMEI" />
            </div>
            <button class="btn primary" type="submit">Scan</button>

            <div class="kpis">
              <div class="chip"><span class="dot"></span><span class="lbl">Total</span><span class="val" id="kpi2-total">0</span></div>
              <div class="chip"><span class="dot"></span><span class="lbl">Scanned</span><span class="val" id="kpi2-scanned">0</span></div>
              <div class="chip"><span class="dot"></span><span class="lbl">Missing</span><span class="val" id="kpi2-missing">0</span></div>
            </div>

            <div class="actions">
              <!-- Download -->
              <div class="menu" id="downloadMenu">
                <button class="btn ghost" type="button" aria-haspopup="true" aria-expanded="false">‚¨áÔ∏è Download</button>
                <div class="menu-list" role="menu">
                  <div class="menu-item" data-export="all"><span>All Rows (CSV)</span><span class="muted">Location, SKU, Desc, IMEIs, Qty</span></div>
                  <div class="menu-item" data-export="scanned"><span>Scanned Only (CSV)</span><span class="muted">Matches = 1</span></div>
                  <div class="menu-item" data-export="missing"><span>Missing Only (CSV)</span><span class="muted">Matches = 0</span></div>
                </div>
              </div>
              <!-- Audit -->
              <button class="btn ghost" id="auditBtn" type="button">üóÇÔ∏è Audit</button>
            </div>
          </form>
        </div>

        <div class="table-wrap">
          <table id="dataTable" aria-describedby="tableDesc">
            <caption id="tableDesc" style="text-align:left;padding:10px 12px;color:var(--ink-3);caption-side:top;">
              System snapshot of IMEIs for the selected bin. Scanned matches turn green.
            </caption>
            <thead>
              <tr>
                <th>Location</th>
                <th>SKU</th>
                <th>Description</th>
                <th>System IMEI</th>
                <th>Scanned IMEI</th>
                <th>Quantity</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </section>

      <!-- EMPTY STATE -->
      <section class="card" id="emptyCard" style="display:block">
        <div class="body empty">Enter a bin location above to load a snapshot, then scan IMEIs here.</div>
      </section>

      <div class="footnote">Wrong-bin scans are logged for audit. Duplicate scans are ignored. Quantity auto-calculates (1 if IMEIs match, else 0).</div>
    </div>
  </main>

  <!-- AUDIT DRAWER -->
  <aside class="drawer" id="auditDrawer" aria-hidden="true">
    <header>
      <div style="display:flex;align-items:center;gap:8px">
        <strong>Wrong-Bin Audit</strong>
        <span class="badge" id="auditCount">0 open</span>
      </div>
      <button class="btn ghost sm" id="auditClose" type="button">Close</button>
    </header>
    <main>
      <div class="alerts" id="auditAlerts" style="display:none"></div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>IMEI</th>
              <th>Scanned Bin</th>
              <th>True Location</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="auditBody">
            <!-- Filled dynamically -->
          </tbody>
        </table>
      </div>
    </main>
  </aside>

  <script>
    // --- Config (front-end calls your Vercel serverless APIs) ------
    const CONFIG = {
      BIN_ENDPOINT: "/api/ordertime/bin?bin=",
      IMEI_ENDPOINT: "/api/ordertime/imei?imei=",
      AUDIT_ENDPOINT: "/api/audit/wrong-bin",
      FORCE_MOCK: false, // set to true to demo without backend
      LOGO_FILENAME: "./downalod.png",
    };

    // --- State -----------------------------------------------------
    let currentBin = "";
    /** @type {{location:string, sku:string, description:string, systemImei:string, scannedImei?:string}[]} */
    let rows = [];
    const scanned = new Set();

    // --- DOM refs --------------------------------------------------
    const binForm = document.getElementById("binForm");
    const binInput = document.getElementById("binInput");
    const binSubmit = document.getElementById("binSubmit");
    const resetBtn = document.getElementById("resetBtn");
    const resultsCard = document.getElementById("resultsCard");
    const emptyCard = document.getElementById("emptyCard");
    const tbody = document.getElementById("tbody");
    const scanForm = document.getElementById("scanForm");
    const scanInput = document.getElementById("scanInput");
    const alerts = document.getElementById("alerts");
    const downloadMenu = document.getElementById("downloadMenu");
    const auditBtn = document.getElementById("auditBtn");
    const auditDrawer = document.getElementById("auditDrawer");
    const auditClose = document.getElementById("auditClose");
    const auditBody = document.getElementById("auditBody");
    const auditAlerts = document.getElementById("auditAlerts");
    const auditCount = document.getElementById("auditCount");

    const kpi = {
      total: document.getElementById("kpi-total"),
      scanned: document.getElementById("kpi-scanned"),
      missing: document.getElementById("kpi-missing"),
      total2: document.getElementById("kpi2-total"),
      scanned2: document.getElementById("kpi2-scanned"),
      missing2: document.getElementById("kpi2-missing"),
    };

    // --- Utilities -------------------------------------------------
    const showAlerts = (el, items=[]) => {
      if (!items.length){ el.style.display="none"; el.innerHTML=""; return; }
      el.style.display="";
      el.innerHTML = items.map(a=>`<div class="alert ${a.type==='warn'?'warn':'ok'}">${a.msg}</div>`).join("");
    };
    const setKPIs = () => {
      const total = rows.length;
      const scannedCount = rows.filter(r => r.scannedImei === r.systemImei).length;
      const missing = total - scannedCount;
      [kpi.total,kpi.total2].forEach(el=>el.textContent=total);
      [kpi.scanned,kpi.scanned2].forEach(el=>el.textContent=scannedCount);
      [kpi.missing,kpi.missing2].forEach(el=>el.textContent=missing);
    };
    const escapeHTML = (s="") => s.replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
    const pad = n => String(n).padStart(2,"0");
    const ts = () => { const d=new Date(); return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`; };

    const renderTable = () => {
      if (!rows.length){ resultsCard.style.display="none"; emptyCard.style.display="block"; setKPIs(); return; }
      resultsCard.style.display="block"; emptyCard.style.display="none";
      tbody.innerHTML = rows.map(r => {
        const matched = r.scannedImei === r.systemImei;
        const qty = matched ? 1 : 0;
        return `<tr class="${matched?'ok':''}">
          <td>${escapeHTML(r.location)}</td>
          <td class="mono">${escapeHTML(r.sku)}</td>
          <td>${escapeHTML(r.description||'‚Äî')}</td>
          <td class="mono">${escapeHTML(r.systemImei)}</td>
          <td class="mono">${escapeHTML(r.scannedImei||'‚Äî')}</td>
          <td><span class="qty ${qty===1?'is1':''}">${qty}</span></td>
        </tr>`;
      }).join("");
      setKPIs();
    };

    const csvEscape = (v="") => /[",\n]/.test(v) ? `"${v.replace(/"/g,'""')}"` : v;
    const toCSV = (data) => {
      const header = ["Location","SKU","Description","System IMEI","Scanned IMEI","Quantity"];
      const lines = [header.join(",")];
      for (const r of data){
        const qty = r.scannedImei===r.systemImei ? 1 : 0;
        lines.push([r.location,r.sku||"",r.description||"",r.systemImei,r.scannedImei||"",String(qty)].map(csvEscape).join(","));
      }
      return lines.join("\n");
    };
    const downloadCSV = (subset="all") => {
      if (!rows.length) return showAlerts(alerts,[{type:"warn",msg:"No rows to export."}]);
      let data = rows;
      if (subset==="scanned") data = rows.filter(r => r.scannedImei===r.systemImei);
      if (subset==="missing") data = rows.filter(r => r.scannedImei!==r.systemImei);
      const csv = toCSV(data);
      const blob = new Blob([csv],{type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const safeBin = (currentBin||"bin").replace(/[^A-Za-z0-9_-]+/g,"-");
      a.href=url; a.download=`connectus_${safeBin}_${ts()}_${subset}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      showAlerts(alerts,[{type:"ok",msg:`Downloading <b>${escapeHTML(a.download)}</b>`}]);
    };

    // --- Mock fallback --------------------------------------------
    const mockBin = bin => {
      const seed = s => Array.from(s).reduce((a,c)=>a+c.charCodeAt(0),0);
      const base = seed(bin)%900000000000000 + 100000000000000;
      const mk = n => String(base+n);
      return [
        { location: bin, sku:"IP12-128-BLK", description:"iPhone 12 128GB Black",  systemImei: mk(1) },
        { location: bin, sku:"GA13-64-5G",   description:"Galaxy A13 5G 64GB",     systemImei: mk(2) },
        { location: bin, sku:"IPAD-9-64",    description:"iPad 9th Gen 64GB Wi-Fi",systemImei: mk(3) },
        { location: bin, sku:"PIX6-128",     description:"Pixel 6 128GB",          systemImei: mk(4) },
      ];
    };
    const mockLocate = (imei,bin) => ({ imei, location: bin.replace(/\d+$/, m=>String((+m||0)+1))||"K-01-02", sku:"‚Äî", description:"‚Äî" });

    // --- Backend calls --------------------------------------------
    async function fetchBinSnapshot(bin){
      if (CONFIG.FORCE_MOCK) return mockBin(bin);
      try{
        const res = await fetch(CONFIG.BIN_ENDPOINT + encodeURIComponent(bin), { cache:"no-store" });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        // Expect { records: [{location,sku,description,systemImei}] }
        return (data.records || []).map(r => ({
          location: r.location || bin,
          sku: r.sku || r.itemCode || "‚Äî",
          description: r.description || r.itemName || "‚Äî",
          systemImei: String(r.systemImei || r.imei || r.serial || ""),
        }));
      }catch(e){
        // graceful demo fallback
        return mockBin(bin);
      }
    }

    async function locateImei(imei){
      if (CONFIG.FORCE_MOCK) return mockLocate(imei, currentBin);
      try{
        const res = await fetch(CONFIG.IMEI_ENDPOINT + encodeURIComponent(imei), { cache:"no-store" });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        if (!data || !data.location) return null;
        return data; // { imei, location, sku?, description? }
      }catch(e){
        return mockLocate(imei, currentBin);
      }
    }

    async function logWrongBin({ imei, scannedBin, trueLocation }) {
      try{
        await fetch(CONFIG.AUDIT_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ imei, scannedBin, trueLocation })
        });
      }catch(_e){ /* non-blocking */ }
    }

    async function fetchAuditList() {
      const res = await fetch(CONFIG.AUDIT_ENDPOINT);
      if (!res.ok) throw new Error(await res.text());
      const { records } = await res.json();
      return Array.isArray(records) ? records : [];
    }

    async function resolveAudit(id){
      const res = await fetch(CONFIG.AUDIT_ENDPOINT, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id })
      });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    // --- Events ----------------------------------------------------
    binForm.addEventListener("submit", async e => {
      e.preventDefault();
      const bin = binInput.value.trim(); if (!bin) return;
      binSubmit.disabled = true;
      showAlerts(alerts,[{type:"ok",msg:`Loading bin <b>${escapeHTML(bin)}</b>‚Ä¶`}]);
      try{
        currentBin = bin; scanned.clear();
        rows = await fetchBinSnapshot(bin);
        showAlerts(alerts,[{type:"ok",msg:`Loaded <b>${rows.length}</b> IMEIs for bin <b>${escapeHTML(bin)}</b>.`}]);
        renderTable(); scanInput.focus();
      }catch(err){
        showAlerts(alerts,[{type:"warn",msg:`Failed to load bin.`}]); rows = []; renderTable();
      }finally{ binSubmit.disabled=false; }
    });

    resetBtn.addEventListener("click", () => {
      currentBin=""; rows=[]; scanned.clear(); binInput.value=""; scanInput.value="";
      showAlerts(alerts,[]); renderTable(); binInput.focus();
    });

    scanForm.addEventListener("submit", async e => {
      e.preventDefault();
      const imei = scanInput.value.trim(); if (!imei) return;

      if (scanned.has(imei)){
        showAlerts(alerts,[{type:"ok",msg:`IMEI <b>${escapeHTML(imei)}</b> already scanned.`}] );
        scanInput.value=""; return;
      }

      const idx = rows.findIndex(r => r.systemImei===imei);
      if (idx>=0){
        rows[idx] = {...rows[idx], scannedImei: imei}; scanned.add(imei);
        showAlerts(alerts,[{type:"ok",msg:`OK: IMEI <b>${escapeHTML(imei)}</b> in bin <b>${escapeHTML(rows[idx].location)}</b>.`}]);
        renderTable(); scanInput.value=""; return;
      }

      // Not in current bin -> find true location + log audit
      const info = await locateImei(imei);
      if (info && info.location){
        showAlerts(alerts,[{type:"warn",msg:`Wrong bin: IMEI <b>${escapeHTML(imei)}</b> is in <b>${escapeHTML(info.location)}</b>, not <b>${escapeHTML(currentBin||'‚Äî')}</b>.`}]);
        // fire-and-forget audit log
        logWrongBin({ imei, scannedBin: currentBin || "-", trueLocation: info.location });
      }else{
        showAlerts(alerts,[{type:"warn",msg:`IMEI <b>${escapeHTML(imei)}</b> not found in ERP.`}]);
      }
      scanInput.value="";
    });

    // Download menu
    const toggleMenu = (open) => {
      downloadMenu.classList.toggle("open", open);
      downloadMenu.querySelector("button").setAttribute("aria-expanded", open?"true":"false");
    };
    downloadMenu.querySelector("button").addEventListener("click", () => toggleMenu(!downloadMenu.classList.contains("open")));
    downloadMenu.querySelectorAll(".menu-item").forEach(item => item.addEventListener("click", () => { downloadCSV(item.getAttribute("data-export")); toggleMenu(false); }));
    document.addEventListener("click", e => { if (!downloadMenu.contains(e.target)) toggleMenu(false); });

    // Audit drawer
    auditBtn.addEventListener("click", async () => {
      auditDrawer.classList.add("open");
      auditDrawer.setAttribute("aria-hidden","false");
      try{
        const list = await fetchAuditList();
        auditCount.textContent = `${list.filter(x=>x.status!=="resolved").length} open`;
        auditBody.innerHTML = list.map(it => `
          <tr>
            <td class="mono">${escapeHTML(it.imei)}</td>
            <td>${escapeHTML(it.scannedBin)}</td>
            <td>${escapeHTML(it.trueLocation)}</td>
            <td><span class="badge">${escapeHTML(it.status || 'open')}</span></td>
            <td class="row-sm">
              ${it.status === "resolved" ? "" : `<button class="btn primary sm" data-resolve="${escapeHTML(it.id)}">Mark Fixed</button>`}
            </td>
          </tr>
        `).join("");
        showAlerts(auditAlerts,[]);
      }catch(err){
        showAlerts(auditAlerts,[{type:"warn",msg:"Failed to load audit list."}]);
      }
    });
    auditClose.addEventListener("click", () => {
      auditDrawer.classList.remove("open");
      auditDrawer.setAttribute("aria-hidden","true");
    });
    auditBody.addEventListener("click", async (e) => {
      const btn = e.target.closest("[data-resolve]");
      if (!btn) return;
      const id = btn.getAttribute("data-resolve");
      btn.disabled = true;
      try{
        await resolveAudit(id);
        // Refresh list
        const list = await fetchAuditList();
        auditCount.textContent = `${list.filter(x=>x.status!=="resolved").length} open`;
        auditBody.innerHTML = list.map(it => `
          <tr>
            <td class="mono">${escapeHTML(it.imei)}</td>
            <td>${escapeHTML(it.scannedBin)}</td>
            <td>${escapeHTML(it.trueLocation)}</td>
            <td><span class="badge">${escapeHTML(it.status || 'open')}</span></td>
            <td class="row-sm">
              ${it.status === "resolved" ? "" : `<button class="btn primary sm" data-resolve="${escapeHTML(it.id)}">Mark Fixed</button>`}
            </td>
          </tr>
        `).join("");
      }catch(err){
        showAlerts(auditAlerts,[{type:"warn",msg:"Failed to resolve item."}]);
      }finally{
        btn.disabled = false;
      }
    });

    // init
    renderTable();
    binInput.focus();
  </script>
</body>
</html>
